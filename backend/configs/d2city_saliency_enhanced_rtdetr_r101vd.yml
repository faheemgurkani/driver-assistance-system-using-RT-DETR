# RT-DETR Config for Saliency-Enhanced D2-City Dataset (R101VD)
# Uses SaliencyEnhancedD2CityDatasetRTDETR
#
# This config is for working with PRE-PROCESSED saliency-enhanced frames.
# These frames have already gone through:
# 1. Input acquisition (D2-City videos)
# 2. Basic preprocessing
# 3. Saliency model processing
# 4. Enhanced frame creation (Frame Ã— Saliency Mask)
#
# No data loading or preprocessing needed - just load enhanced frames directly.

__include__:
  - ./rtdetr_base/runtime.yml
  - ./rtdetr_base/rtdetr/include/dataloader.yml
  - ./rtdetr_base/rtdetr/include/optimizer.yml
  - ./rtdetr_base/rtdetr/include/rtdetr_r50vd.yml

task: detection

num_classes: 80 # COCO classes (for transfer learning)
remap_mscoco_category: True

# Override for R101VD
PResNet:
  depth: 101

HybridEncoder:
  # intra
  hidden_dim: 384
  dim_feedforward: 2048

RTDETRTransformer:
  feat_channels: [384, 384, 384]

train_dataloader:
  type: DataLoader
  dataset:
    type: SaliencyEnhancedD2CityDatasetRTDETR
    root_dir: ./data/T2-saliency/enhanced_frames
    image_extensions: [".jpg", ".jpeg", ".png"]
    return_masks: False
    annotations_dir: ./data/annotations
    transforms:
      type: Compose
      ops:
        - type: RandomPhotometricDistort
        - type: RandomZoomOut
          fill: 0
        - type: RandomHorizontalFlip
          p: 0.5
        - type: Resize
          size: [640, 640]
        - type: ToImageTensor
        - type: ConvertDtype
        - type: SanitizeBoundingBox
          min_size: 1
        - type: ConvertBox
          out_fmt: "cxcywh"
          normalize: True
  shuffle: True
  batch_size: 2
  num_workers: 2
  drop_last: True

val_dataloader:
  type: DataLoader
  dataset:
    type: SaliencyEnhancedD2CityDatasetRTDETR
    root_dir: ./data/T2-saliency/enhanced_frames
    image_extensions: [".jpg", ".jpeg", ".png"]
    return_masks: False
    annotations_dir: ./data/annotations
    transforms:
      type: Compose
      ops:
        - type: Resize
          size: [640, 640]
        - type: ToImageTensor
        - type: ConvertDtype
        - type: SanitizeBoundingBox
          min_size: 1
        - type: ConvertBox
          out_fmt: "cxcywh"
          normalize: True
  shuffle: False
  batch_size: 2
  num_workers: 2
  drop_last: False

output_dir: ./output/d2city_saliency_enhanced_rtdetr_r101vd

# Fine-tuning settings
epoches: 1
log_step: 10
checkpoint_step: 1
use_ema: True
use_amp: True
clip_max_norm: 0.1
# Gradient checkpointing is enabled by default in RT-DETR code
# (HybridEncoder and RTDETRTransformer use checkpoint=True for memory efficiency)

# Device selection: Automatic (CUDA > MPS > CPU)
# MPS (Apple Silicon GPU) is automatically enabled if available
# Note: AMP scaler is only used with CUDA; MPS training works without scaler

